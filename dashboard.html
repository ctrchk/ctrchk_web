<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>用戶儀表板 - CTRC HK</title>
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <script>
        // 這是「頁面守衛」，它會在頁面渲染前執行
        // 檢查是否有 Supabase session 或傳統 token
        function checkAuth() {
            const token = localStorage.getItem('accessToken');
            
            if (!token) {
                alert('你需要登入才能查看此頁面。');
                window.location.replace('/login.html'); 
                return false;
            }
            return true;
        }
        
        // 立即檢查
        if (!checkAuth()) {
            // 如果檢查失敗，停止執行
            throw new Error('未授權訪問');
        }
    </script>
</head>
<body>
    <div id="header-placeholder"></div>

    <main>
        <section class="hero">
            <h1>歡迎回來！</h1>
            <p id="welcome-email">正在載入你的資料...</p>
            <p id="membership-status" style="font-size: 0.9em; color: #666;"></p>
        </section>

        <div id="upgrade-notice" style="display: none; background: #fff3cd; border: 2px solid #ffc107; padding: 1.5em; margin: 2em auto; max-width: 800px; border-radius: 8px; text-align: center;">
            <h3 style="color: #856404; margin-top: 0;">
                <i class="fas fa-star" style="color: #ffc107;"></i>
                升級為高級會員以享受完整功能
            </h3>
            <p style="color: #856404;">完善您的個人資料即可升級為高級會員，解鎖所有功能！</p>
            <a href="/profile-setup.html" class="cta-button" style="display: inline-block; margin-top: 1em; background-color: #ffc107; color: #000;">
                <i class="fas fa-arrow-right"></i> 立即升級
            </a>
        </div>

        <section class="content animated-element">
            <h2>你的騎行歷史</h2>
            <div id="history-container">
            </div>
            
            <div id="admin-section" style="display:none; margin-top: 3em;">
                <h2>管理員面板</h2>
                <p>你可以開始管理 Blog 文章了。</p>
                <a href="/admin/create-post.html" class="cta-button">撰寫新文章</a>
            </div>
        </section>
    </main>

    <footer>
        <p>&copy; 2025 香港城市運輸單車 CTRC HK. All Rights Reserved.</p>
    </footer>

    <script src="/js/main.js"></script>
    <script src="/js/supabase-config.js"></script>
    <script src="/js/login.js"></script> 
    
    <script>
        // 等待所有東西載入完畢
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // 優先使用 Supabase 獲取用戶資料
                let user = null;
                let userRole = 'junior';
                let profileCompleted = false;
                
                if (window.supabase) {
                    const { data: { user: supabaseUser } } = await window.supabase.auth.getUser();
                    if (supabaseUser) {
                        // For Google OAuth users, also check database
                        try {
                            const dbResponse = await fetch(`/api/get-user?google_id=${supabaseUser.id}`);
                            if (dbResponse.ok) {
                                const dbUser = await dbResponse.json();
                                userRole = dbUser.user_role || 'junior';
                                profileCompleted = dbUser.profile_completed || false;
                            }
                        } catch (error) {
                            console.error('Error fetching user from database:', error);
                            userRole = supabaseUser.user_metadata?.user_role || 'junior';
                            profileCompleted = supabaseUser.user_metadata?.profile_completed || false;
                        }
                        
                        user = {
                            id: supabaseUser.id,
                            email: supabaseUser.email,
                            role: userRole
                        };
                    }
                }
                
                // 如果 Supabase 沒有用戶，回退到傳統方式
                if (!user) {
                    user = getUserData();
                    if (user) {
                        userRole = user.role || 'junior';
                    }
                }
                
                if (user) {
                    document.getElementById('welcome-email').textContent = `你好, ${user.email}`;
                    
                    // Display membership status
                    const statusElement = document.getElementById('membership-status');
                    if (userRole === 'senior') {
                        statusElement.innerHTML = '<i class="fas fa-star" style="color: #ffc107;"></i> 高級會員';
                        statusElement.style.color = '#ffc107';
                    } else {
                        statusElement.innerHTML = '<i class="fas fa-user" style="color: #666;"></i> 初級會員';
                        // Show upgrade notice for junior members
                        document.getElementById('upgrade-notice').style.display = 'block';
                    }
                    
                    // 檢查是否為管理員
                    if (user.role === 'admin') {
                        document.getElementById('admin-section').style.display = 'block';
                    }
                }
            
            // 載入騎行歷史
            loadCyclingHistory();
            
            } catch (error) {
                console.error('獲取用戶資料失敗:', error);
            }
        });

        async function loadCyclingHistory() {
            const container = document.getElementById('history-container');
            container.textContent = '正在載入歷史紀錄...';
            
            try {
                // 這是我們在 login.js 中會建立的函數
                const historyData = await fetchProtectedData('/api/getHistory'); 
                
                if (historyData.length === 0) {
                    container.textContent = '你目前沒有任何騎行歷史。';
                    return;
                }

                // 渲染數據
                container.innerHTML = ''; // 清空
                const ul = document.createElement('ul');
                historyData.forEach(ride => {
                    const li = document.createElement('li');
                    li.textContent = `日期: ${ride.ride_date}, 距離: ${ride.distance_km} km`;
                    ul.appendChild(li);
                });
                container.appendChild(ul);
                
            } catch (error) {
                // fetchProtectedData 內部會處理 401 跳轉
                console.error('載入歷史失敗:', error);
                container.textContent = `載入失敗: ${error.message}`;
            }
        }
    </script>
</body>
</html>