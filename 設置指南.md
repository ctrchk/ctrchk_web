# CTRC HK 網站登入系統完整設置指南

本指南將詳細說明如何設置您的網站登入系統，解決「註冊失敗」和「Google 登入失敗」的問題。

## 目錄
1. [問題說明](#問題說明)
2. [必需的設置步驟](#必需的設置步驟)
3. [Vercel Postgres 資料庫設置](#步驟一-vercel-postgres-資料庫設置)
4. [Supabase Google OAuth 設置](#步驟二-supabase-google-oauth-設置)
5. [環境變數設置](#步驟三-環境變數設置)
6. [測試驗證](#步驟四-測試驗證)
7. [常見問題排解](#常見問題排解)

---

## 問題說明

您遇到的兩個錯誤原因如下：

### 1. 註冊失敗：「The string did not match the expected pattern」
**原因**：Vercel Postgres 資料庫尚未建立或資料表（users table）尚未創建。

### 2. Google 登入失敗：「Supabase auth 方法不可用」
**原因**：Supabase 的 Google OAuth 提供商尚未啟用或配置不完整。

---

## 必需的設置步驟

您需要完成以下三個主要設置：

1. ✅ **Vercel Postgres 資料庫** - 用於儲存用戶資料
2. ✅ **Supabase Google OAuth** - 用於 Google 登入功能
3. ✅ **環境變數** - 用於安全性設置

---

## 步驟一：Vercel Postgres 資料庫設置

### 1.1 創建 Postgres 資料庫

1. 登入 [Vercel Dashboard](https://vercel.com/dashboard)
2. 選擇您的專案（ctrchk_web）
3. 點擊頂部的 **「Storage」** 標籤
4. 點擊 **「Create Database」** 按鈕
5. 選擇 **「Postgres」**
6. 選擇離您用戶最近的區域（建議：Hong Kong 或 Singapore）
7. 點擊 **「Create」**
8. 等待資料庫創建完成（約 1-2 分鐘）

### 1.2 執行資料庫架構（Schema）

資料庫創建後，您需要執行 SQL 指令來建立資料表：

1. 在 Vercel Dashboard 中，進入 **Storage** → 選擇您剛建立的 Postgres 資料庫
2. 點擊 **「Query」** 標籤
3. 複製以下 SQL 指令（或從專案中的 `database-schema.sql` 檔案複製）

```sql
-- 建立用戶資料表
CREATE TABLE IF NOT EXISTS users (
    id SERIAL PRIMARY KEY,
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255), -- Google OAuth 用戶此欄位為 NULL
    user_role VARCHAR(20) DEFAULT 'junior',
    full_name VARCHAR(100),
    phone VARCHAR(20),
    birthdate DATE,
    experience VARCHAR(20),
    bike_type VARCHAR(20),
    preferred_area VARCHAR(50),
    profile_completed BOOLEAN DEFAULT FALSE,
    profile_completion_date TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW(),
    auth_provider VARCHAR(20) DEFAULT 'email',
    google_id VARCHAR(255)
);

-- 建立索引以提升查詢效能
CREATE INDEX IF NOT EXISTS idx_users_email ON users(email);
CREATE INDEX IF NOT EXISTS idx_users_google_id ON users(google_id);
CREATE INDEX IF NOT EXISTS idx_users_role ON users(user_role);

-- 建立騎行歷史記錄表
CREATE TABLE IF NOT EXISTS cycling_history (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
    ride_date DATE NOT NULL,
    distance_km DECIMAL(10, 2),
    route_name VARCHAR(255),
    created_at TIMESTAMP DEFAULT NOW()
);

-- 建立索引
CREATE INDEX IF NOT EXISTS idx_cycling_history_user_id ON cycling_history(user_id);
CREATE INDEX IF NOT EXISTS idx_cycling_history_ride_date ON cycling_history(ride_date);
```

4. 將上述 SQL 指令貼到查詢框中
5. 點擊 **「Run Query」** 執行
6. 確認看到成功訊息，例如：「Query executed successfully」

### 1.3 驗證資料表已建立

執行以下查詢來確認資料表已正確建立：

```sql
SELECT table_name 
FROM information_schema.tables 
WHERE table_schema = 'public';
```

您應該會看到：
- `users`
- `cycling_history`

---

## 步驟二：Supabase Google OAuth 設置

### 2.1 登入 Supabase

1. 前往 [Supabase Dashboard](https://supabase.com/dashboard)
2. 使用您的 Supabase 帳號登入
3. 選擇專案：`umpxhvqcldmrmkuipmao`（或您的專案）

### 2.2 設置 Google OAuth 提供商

1. 在左側選單中，點擊 **「Authentication」**
2. 選擇 **「Providers」** 標籤
3. 找到 **「Google」** 提供商
4. 點擊右側的開關，**啟用** Google 提供商

### 2.3 設置 Google OAuth 憑證（如果還沒有）

如果您還沒有 Google OAuth 憑證，需要先創建：

1. 前往 [Google Cloud Console](https://console.cloud.google.com/)
2. 創建新專案或選擇現有專案
3. 啟用 **Google+ API**
4. 前往 **「APIs & Services」** → **「Credentials」**
5. 點擊 **「Create Credentials」** → **「OAuth 2.0 Client ID」**
6. 選擇應用程式類型：**「Web application」**
7. 設定名稱：例如「CTRC HK Web」
8. 在 **「Authorized redirect URIs」** 中添加：
   ```
   https://umpxhvqcldmrmkuipmao.supabase.co/auth/v1/callback
   ```
9. 點擊 **「Create」**
10. 複製 **Client ID** 和 **Client Secret**

### 2.4 在 Supabase 中設置 Google 憑證

回到 Supabase Dashboard 的 Google 提供商設定：

1. 將 Google **Client ID** 貼到對應欄位
2. 將 Google **Client Secret** 貼到對應欄位
3. 點擊 **「Save」** 儲存

### 2.5 設置授權重定向 URL

在 Supabase 的 Google 提供商設定中：

1. 找到 **「Redirect URLs」** 或 **「Site URL」** 設定
2. 添加您的網站網址：
   - 生產環境：`https://www.ctrchk.com/auth-callback.html`
   - 如果使用 Vercel 預設網址：`https://your-project.vercel.app/auth-callback.html`
   - 本地測試：`http://localhost:3000/auth-callback.html`（可選）

3. 點擊 **「Save」** 儲存

**重要**：同時也需要在 Google Cloud Console 中添加這些重定向 URL：

1. 回到 Google Cloud Console → **「Credentials」**
2. 編輯您的 OAuth 2.0 Client ID
3. 在 **「Authorized redirect URIs」** 中添加：
   ```
   https://umpxhvqcldmrmkuipmao.supabase.co/auth/v1/callback
   https://www.ctrchk.com/auth-callback.html
   ```
4. 點擊 **「Save」**

---

## 步驟三：環境變數設置

### 3.1 設置 JWT Secret

1. 在 Vercel Dashboard 中，選擇您的專案
2. 前往 **「Settings」** → **「Environment Variables」**
3. 點擊 **「Add New」**
4. 設定如下：
   - **Name**: `JWT_SECRET`
   - **Value**: 生成一個安全的隨機字串（至少 32 字元）

**如何生成安全的 JWT_SECRET**：

方法一：使用線上工具
- 前往 [Random.org](https://www.random.org/strings/)
- 生成一個 64 字元的隨機字串

方法二：使用 Node.js（如果您有安裝）
```bash
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
```

方法三：使用密碼生成器
- 生成一個至少 32 字元、包含大小寫字母和數字的強密碼

5. 選擇環境：**「Production」**、**「Preview」**、**「Development」**（全選）
6. 點擊 **「Save」**

### 3.2 驗證資料庫環境變數

Vercel 應該已自動設置以下環境變數（當您創建 Postgres 資料庫時）：

- `POSTGRES_URL`
- `POSTGRES_PRISMA_URL`
- `POSTGRES_URL_NON_POOLING`

請確認這些變數存在於 **「Environment Variables」** 頁面中。

### 3.3 重新部署

設置環境變數後，需要重新部署：

1. 前往 **「Deployments」** 標籤
2. 找到最新的部署
3. 點擊右側的 **「...」** 選單
4. 選擇 **「Redeploy」**
5. 等待部署完成

---

## 步驟四：測試驗證

### 4.1 測試電子郵件註冊

1. 前往您的網站：`https://www.ctrchk.com/register.html`
2. 填寫註冊表單：
   - 電子郵件：使用測試郵件（例如：test@example.com）
   - 密碼：至少 8 個字元
   - 填寫所有必填欄位
3. 點擊 **「註冊並成為高級會員」**
4. 應該看到：「註冊成功！您已成為高級會員。將跳轉至登入頁面。」
5. 自動跳轉到登入頁面

### 4.2 測試電子郵件登入

1. 在登入頁面輸入剛才註冊的郵件和密碼
2. 點擊 **「登入」**
3. 應該看到：「登入成功！」
4. 自動跳轉到儀表板（Dashboard）

### 4.3 測試 Google 登入

1. 前往登入頁面：`https://www.ctrchk.com/login.html`
2. 點擊 **「使用 Google 登入」** 按鈕
3. 應該會重定向到 Google 登入頁面
4. 選擇您的 Google 帳號
5. 授權應用程式訪問您的基本資料
6. 應該會重定向回您的網站
7. 如果是第一次使用 Google 登入，會跳轉到個人資料設置頁面

### 4.4 檢查資料庫

回到 Vercel Postgres 的 Query 標籤，執行：

```sql
SELECT id, email, user_role, profile_completed, auth_provider, created_at 
FROM users 
ORDER BY created_at DESC;
```

您應該會看到剛才註冊的測試用戶。

---

## 常見問題排解

### Q1: 註冊時仍然出現「The string did not match the expected pattern」

**解決方法**：
1. 確認 Postgres 資料庫已建立
2. 確認已執行 `database-schema.sql` 中的 SQL 指令
3. 在 Vercel Postgres Query 中執行：
   ```sql
   SELECT * FROM users LIMIT 1;
   ```
   如果出現錯誤「relation "users" does not exist」，表示資料表尚未建立，請重新執行步驟一。

### Q2: Google 登入仍然失敗

**解決方法**：
1. 開啟瀏覽器開發者工具（F12）
2. 查看 Console 標籤中的錯誤訊息
3. 常見問題：
   - **「Supabase 載入超時」**：檢查網路連線，重新整理頁面
   - **「Google 登入功能尚未啟用」**：確認在 Supabase 中已啟用 Google 提供商
   - **「redirect_uri_mismatch」**：檢查 Google Cloud Console 中的重定向 URL 是否正確

### Q3: 環境變數設置後仍然不生效

**解決方法**：
1. 確認環境變數已儲存
2. 重新部署專案（見步驟三.3）
3. 清除瀏覽器快取並重新整理頁面

### Q4: 資料庫連線錯誤

**解決方法**：
1. 檢查 Vercel Postgres 資料庫狀態（應該是 Active）
2. 確認環境變數 `POSTGRES_URL` 存在
3. 在 Vercel Dashboard 的 Deployments → Function Logs 中查看詳細錯誤訊息

### Q5: Google 登入後沒有跳轉

**解決方法**：
1. 檢查 `auth-callback.html` 檔案是否存在
2. 確認 Supabase 中的 Site URL 設定正確
3. 確認 Google Cloud Console 中的重定向 URL 包含您的網站網址

### Q6: 在 Namecheap 設定的自訂網域無法登入

**解決方法**：
1. 確認 Namecheap 的 DNS 設定已指向 Vercel
2. 在 Vercel Dashboard → Settings → Domains 中確認網域已連接
3. 更新 Supabase 和 Google OAuth 的重定向 URL，使用您的自訂網域：
   - 將 `https://your-project.vercel.app` 改為 `https://www.ctrchk.com`

---

## 需要協助？

如果按照上述步驟仍然無法解決問題：

1. **查看 Vercel 部署日誌**：
   - Vercel Dashboard → Deployments → [最新部署] → Function Logs
   - 查找 `/api/register` 或 `/api/google-auth` 的錯誤訊息

2. **查看瀏覽器 Console**：
   - 按 F12 開啟開發者工具
   - 切換到 Console 標籤
   - 嘗試註冊或登入，查看錯誤訊息

3. **檢查網路請求**：
   - 開發者工具 → Network 標籤
   - 嘗試註冊或登入
   - 查看 `/api/register` 或 `/api/google-auth` 的請求和回應

4. **檢查相關文件**：
   - `DATABASE-SETUP.md` - 資料庫詳細設置說明（英文）
   - `DEPLOYMENT-CHECKLIST.md` - 部署檢查清單（英文）
   - `TESTING-GUIDE.md` - 測試指南（英文）

---

## 完成設置後

恭喜！您的登入系統現在應該已經可以正常運作了。

**會員系統說明**：
- **高級會員（Senior）**：透過電子郵件註冊的用戶，立即成為高級會員，享有完整功能
- **初級會員（Junior）**：透過 Google 登入的用戶，初始為初級會員，完成個人資料設置後升級為高級會員

**主要功能**：
- ✅ 電子郵件註冊和登入
- ✅ Google OAuth 登入
- ✅ 會員等級管理
- ✅ 個人資料管理
- ✅ 騎行歷史記錄
- ✅ 儀表板功能

祝您使用愉快！🚴‍♂️

---

**最後更新**：2025-01-31
**版本**：1.0
